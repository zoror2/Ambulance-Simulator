<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Emergency Alert Receiver</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 500px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        margin-bottom: 10px;
        font-size: 24px;
      }
      .subtitle {
        text-align: center;
        opacity: 0.8;
        margin-bottom: 30px;
        font-size: 14px;
      }
      .status-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }
      .status-indicator {
        text-align: center;
        font-size: 64px;
        margin: 20px 0;
      }
      .status-text {
        text-align: center;
        font-size: 18px;
        font-weight: bold;
      }
      .alert-card {
        background: #e74c3c;
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        display: none;
        animation: pulse 1s infinite;
      }
      .alert-card.active {
        display: block;
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }
      .alert-card h2 {
        margin-bottom: 10px;
        font-size: 22px;
      }
      .alert-info {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }
      .alert-info p {
        margin: 8px 0;
        font-size: 14px;
      }
      button {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        margin: 10px 0;
        transition: all 0.3s;
      }
      .enable-btn {
        background: #2ecc71;
        color: white;
      }
      .disable-btn {
        background: #95a5a6;
        color: white;
      }
      .log {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 10px;
        max-height: 200px;
        overflow-y: auto;
        font-size: 12px;
        font-family: "Courier New", monospace;
        margin-top: 20px;
      }
      .distance-bar {
        height: 30px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        overflow: hidden;
        margin: 15px 0;
      }
      .distance-fill {
        height: 100%;
        background: linear-gradient(90deg, #2ecc71, #f39c12, #e74c3c);
        transition: width 0.5s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }
      .vibrate-test {
        background: #9b59b6;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸš¨ Emergency Alert Receiver</h1>
      <p class="subtitle">Receiving ambulance proximity alerts</p>

      <div class="status-card">
        <div class="status-indicator" id="status-icon">âš«</div>
        <div class="status-text" id="status-text">
          Waiting for connection...
        </div>
        <button class="enable-btn" onclick="enableNotifications()">
          ðŸ”” Enable Alerts
        </button>
        <button class="vibrate-test" onclick="testVibration()">
          ðŸ“³ Test Vibration
        </button>
      </div>

      <div class="alert-card" id="alert-card">
        <h2>ðŸš‘ AMBULANCE APPROACHING!</h2>
        <p style="font-size: 16px; margin: 10px 0">
          Please give way immediately
        </p>

        <div class="distance-bar">
          <div class="distance-fill" id="distance-fill" style="width: 50%">
            <span id="distance-text">250m away</span>
          </div>
        </div>

        <div class="alert-info">
          <p>
            <strong>Ambulance ID:</strong> <span id="ambulance-id">---</span>
          </p>
          <p><strong>Speed:</strong> <span id="ambulance-speed">---</span></p>
          <p><strong>Last Update:</strong> <span id="last-update">---</span></p>
        </div>
      </div>

      <div class="status-card">
        <h3 style="margin-bottom: 10px">ðŸ“Š Statistics</h3>
        <p>Total Alerts Received: <strong id="alert-count">0</strong></p>
        <p>
          Connection Status:
          <strong id="connection-status">Disconnected</strong>
        </p>
        <p>Device ID: <strong id="device-id">---</strong></p>
      </div>

      <div class="log" id="log">System starting...</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let notificationsEnabled = false;
      let alertCount = 0;
      let deviceId = "DEVICE_" + Math.random().toString(36).substr(2, 9);

      document.getElementById("device-id").textContent = deviceId;

      function addLog(message) {
        const log = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        log.innerHTML += `\n[${timestamp}] ${message}`;
        log.scrollTop = log.scrollHeight;
      }

      function enableNotifications() {
        if ("Notification" in window) {
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              notificationsEnabled = true;
              addLog("âœ… Notifications enabled");
              document.getElementById("status-icon").textContent = "ðŸŸ¢";
              document.getElementById("status-text").textContent =
                "Ready to receive alerts";

              // Vibrate to confirm
              if ("vibrate" in navigator) {
                navigator.vibrate([200, 100, 200]);
              }
            } else {
              addLog("âŒ Notification permission denied");
            }
          });
        } else {
          addLog("âŒ Notifications not supported");
        }
      }

      function testVibration() {
        if ("vibrate" in navigator) {
          navigator.vibrate([200, 100, 200, 100, 200]);
          addLog("ðŸ“³ Vibration test triggered");
        } else {
          addLog("âŒ Vibration not supported on this device");
        }
      }

      function showAlert(ambulanceData) {
        const alertCard = document.getElementById("alert-card");
        alertCard.classList.add("active");

        document.getElementById("ambulance-id").textContent = ambulanceData.id;
        document.getElementById("ambulance-speed").textContent =
          ambulanceData.speed ? `${ambulanceData.speed} km/h` : "---";
        document.getElementById("last-update").textContent = new Date(
          ambulanceData.timestamp
        ).toLocaleTimeString();

        // Calculate fake distance for demo
        const distance = Math.floor(Math.random() * 500);
        const distancePercent = (distance / 500) * 100;

        document.getElementById("distance-fill").style.width = `${
          100 - distancePercent
        }%`;
        document.getElementById(
          "distance-text"
        ).textContent = `${distance}m away`;

        // Send notification
        if (notificationsEnabled && Notification.permission === "granted") {
          new Notification("ðŸš¨ EMERGENCY AMBULANCE!", {
            body: `Ambulance ${ambulanceData.id} is ${distance}m away. Please give way!`,
            icon: "ðŸš‘",
            vibrate: [300, 200, 300, 200, 300],
            tag: "ambulance-" + ambulanceData.id,
            requireInteraction: true,
          });
        }

        // Vibrate
        if ("vibrate" in navigator) {
          navigator.vibrate([300, 200, 300]);
        }

        alertCount++;
        document.getElementById("alert-count").textContent = alertCount;

        addLog(`ðŸš¨ Alert received from ${ambulanceData.id} at ${distance}m`);

        // Auto-hide after 5 seconds
        setTimeout(() => {
          alertCard.classList.remove("active");
        }, 5000);
      }

      // Socket connection
      socket.on("connect", () => {
        addLog("âœ… Connected to server");
        document.getElementById("connection-status").textContent = "Connected";
        document.getElementById("status-icon").textContent = "ðŸŸ¡";
        document.getElementById("status-text").textContent =
          "Connected - Enable alerts to receive notifications";

        // Register this device
        socket.emit("device:register", {
          id: deviceId,
          name: navigator.userAgent.match(/iPhone|iPad|Android/)
            ? "Mobile Device"
            : "Desktop",
          type: "receiver",
        });
      });

      socket.on("disconnect", () => {
        addLog("âŒ Disconnected from server");
        document.getElementById("connection-status").textContent =
          "Disconnected";
        document.getElementById("status-icon").textContent = "ðŸ”´";
        document.getElementById("status-text").textContent = "Connection lost";
      });

      // Listen for ambulance broadcasts
      socket.on("ambulance:proximity-broadcast", (ambulanceData) => {
        showAlert(ambulanceData);
      });

      socket.on("ambulance:update", (data) => {
        showAlert(data);
      });

      addLog("ðŸš€ System ready - Enable notifications to receive alerts");
    </script>
  </body>
</html>
